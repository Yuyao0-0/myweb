<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moulds 市集（单页版）</title>
  <meta name="description" content="简洁的模具列表，支持本机编辑与 JSON 导出，适合 GitHub Pages 发布。" />
  <style>
    :root{
      --bg:#0a0f1a;
      --panel:#0f1524;
      --card:#121a2e;
      --text:#e6f0ff;
      --muted:#91a1c6;
      --primary:#6cf2ff;
      --primary-2:#9f7bff;
      --accent:#00ffa3;
      --danger:#ff5c8a;
      --ok:#4be477;
      --border:rgba(151,200,255,.15);
      --chip:#1b2542;
      --chip-on:#132f3f;
      --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px var(--border);
      --radius:14px;
    }
    html,body{margin:0;height:100%;background: radial-gradient(1200px 600px at 10% -10%, rgba(156,115,255,.18), transparent 45%), linear-gradient(180deg, #080b14 0%, #0a0f1a 60%, #0a0f1a 100%); color:var(--text); font:16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    a{color:var(--primary)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;background:rgba(10,15,26,.7);backdrop-filter: blur(10px); border-bottom:1px solid var(--border); z-index:20}
    header .container{display:flex;gap:14px;align-items:center}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--primary),var(--primary-2));box-shadow:0 0 20px rgba(108,242,255,.3), inset 0 0 18px rgba(0,0,0,.2)}
    .title{font-size:18px;font-weight:700;letter-spacing:.3px}
    .tag{font-size:12px;color:var(--muted);padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.02)}
    .toolbar{margin-left:auto;display:flex;gap:10px;align-items:center}
    .btn{border:1px solid var(--border); background:linear-gradient(180deg,#121a2e,#0f1524); color:var(--text); padding:9px 12px;border-radius:12px;cursor:pointer; box-shadow:var(--shadow); display:inline-flex; align-items:center; gap:8px}
    .btn:hover{border-color:rgba(151,200,255,.35)}
    .btn.primary{border-color:rgba(108,242,255,.5); background:linear-gradient(180deg,#132a35,#0f1e29); box-shadow:0 10px 30px rgba(108,242,255,.15), inset 0 0 0 1px rgba(108,242,255,.3)}
    .btn.danger{border-color:rgba(255,92,138,.3); background:linear-gradient(180deg,#2b1520,#20101a)}
    .switch{display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}
    input[type="checkbox"]{width:18px;height:18px; accent-color: var(--accent)}
    main .container{display:grid; grid-template-columns:280px 1fr; gap:18px}
    .panel{background:linear-gradient(180deg,#0f1524,#0c1220); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .panel h3{margin:6px 0 12px 0; font-size:14px; color:#cfe3ff; letter-spacing:.2px}
    .filters .row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    .chip{padding:8px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); color:#cfe3ff; cursor:pointer; font-size:13px}
    .chip.active{background:var(--chip-on); border-color:rgba(108,242,255,.4); box-shadow:0 0 0 1px rgba(108,242,255,.15) inset}
    .input, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background: #0c1220; color:var(--text); outline:none}
    .range{display:flex; gap:8px}
    .range input{width:100%}
    .meta{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: repeat(3,1fr); gap:16px}
    @media (max-width: 1000px){ main .container{grid-template-columns:1fr} .grid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 680px){ .grid{grid-template-columns: 1fr} }
    .card{background:linear-gradient(180deg,#10172a,#0d1324); border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column}
    .thumb{position:relative; aspect-ratio: 4/3; background:#0a0f1a; overflow:hidden}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .price{position:absolute; bottom:10px; left:10px; padding:6px 10px; background: rgba(10,15,26,.6); backdrop-filter: blur(6px); border:1px solid var(--border); border-radius:10px; color:#eafff7}
    .body{padding:12px}
    .name{font-weight:700; font-size:16px; margin:4px 0 6px}
    .badges{display:flex; gap:6px; flex-wrap:wrap}
    .badge{font-size:12px; color:#cfe3ff; border:1px solid var(--border); padding:3px 8px; border-radius:999px; background: rgba(255,255,255,.02)}
    .desc{color:#a9b7d6; font-size:13px; margin-top:8px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient: vertical; overflow:hidden}
    .listbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px}
    .pager{display:flex; gap:6px; align-items:center}
    .pager .btn{padding:7px 10px}
    .muted{color:var(--muted)}
    footer{padding:30px 0; color:#99a7c6; text-align:center}
    /* 编辑器 */
    .editor{margin-top:12px}
    .editor .tips{font-size:13px; color:#b7c7e6; background:rgba(156,115,255,.08); border:1px dashed rgba(156,115,255,.4); padding:10px; border-radius:10px}
    .editor .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .editor .row{display:flex; gap:10px; align-items:center; margin:8px 0}
    .editor .imgs{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
    .editor .imgs .ph{width:80px; height:64px; border:1px solid var(--border); border-radius:8px; overflow:hidden; position:relative; background:#0a0f1a}
    .editor .imgs img{width:100%; height:100%; object-fit:cover}
    .editor .imgs .tools{position:absolute; right:4px; top:4px; display:flex; gap:4px}
    .mini{font-size:12px; padding:5px 8px; border-radius:8px}
    .sep{height:1px; background:var(--border); margin:12px 0}
    code.k{color:#8ee7ff}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Moulds 市集</div>
          <div class="tag">单页 · 本机编辑 · JSON 发布</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnReload">重新加载数据</button>
        <label class="switch"><input type="checkbox" id="toggleEdit"> 编辑模式</label>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- 侧栏筛选 -->
      <aside class="panel filters">
        <h3>筛选</h3>
        <div class="row">
          <input id="q" class="input" placeholder="关键词（名称/描述）" />
        </div>
        <div class="row">
          <select id="category">
            <option value="">分类（全部）</option>
          </select>
        </div>
        <div class="row">
          <select id="process" multiple size="4" title="按住 Ctrl/⌘ 可多选">
          </select>
        </div>
        <div class="row">
          <select id="material" multiple size="4" title="按住 Ctrl/⌘ 可多选">
          </select>
        </div>
        <div class="row range">
          <input id="minPrice" type="number" class="input" placeholder="最低价 USD" min="0" step="1" />
          <input id="maxPrice" type="number" class="input" placeholder="最高价 USD" min="0" step="1" />
        </div>
        <div class="row">
          <button class="btn mini" id="btnReset">重置筛选</button>
        </div>
        <div class="sep"></div>
        <div class="row">
          <select id="sort">
            <option value="latest">排序：最新优先</option>
            <option value="priceAsc">价格从低到高</option>
            <option value="priceDesc">价格从高到低</option>
            <option value="nameAsc">名称 A-Z</option>
          </select>
        </div>
        <div class="row">
          <select id="perPage">
            <option value="12">每页 12 条</option>
            <option value="24">每页 24 条</option>
            <option value="48">每页 48 条</option>
          </select>
        </div>

        <!-- 编辑面板（仅编辑模式显示） -->
        <div id="editPanel" class="editor" style="display:none">
          <div class="sep"></div>
          <h3>编辑（本机，不会上传）</h3>
          <div class="tips">
            - 这里的更改只保存在你的浏览器本地。<br>
            - 点击“导出 JSON”后，把 <code class="k">products.json</code> 上传到你的 GitHub 仓库即可对外生效。<br>
            - 勾选“嵌入图片（Base64）”最省心：只要上传一个 JSON 文件，无需单独上传图片。
          </div>
          <div class="row">
            <button class="btn primary mini" id="btnNew">+ 新建条目</button>
            <button class="btn mini" id="btnImport">导入 JSON</button>
            <button class="btn mini" id="btnSaveLocal">保存到本机(localStorage)</button>
          </div>
          <div class="row">
            <label class="switch">
              <input type="checkbox" id="embedImages" checked />
              <span>导出时嵌入图片（Base64）</span>
            </label>
            <button class="btn mini" id="btnExport">导出 JSON</button>
          </div>
          <div id="editList" class="row" style="flex-direction:column; align-items:stretch; gap:8px;"></div>
        </div>
      </aside>

      <!-- 列表 -->
      <section>
        <div class="panel">
          <div class="listbar">
            <div class="meta"><span id="count">0</span> 个结果</div>
            <div class="pager">
              <button class="btn mini" id="prev">上一页</button>
              <span class="muted" id="pageInfo">第 1/1 页</span>
              <button class="btn mini" id="next">下一页</button>
            </div>
          </div>
          <div id="grid" class="grid"></div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    © 2025 Moulds 单页示例 · 数据可存本机或 products.json · 图片可嵌入 JSON 或用相对路径
  </footer>

  <script>
  // ====== 数据与状态 ======
  const LS_KEY_MAIN = 'productsData';      // 本工具使用的key
  const LS_KEY_OLD  = 'dynamicData';       // 兼容之前的key
  let state = {
    all: [],
    filtered: [],
    page: 1,
    perPage: 12,
    sort: 'latest',
    filters: { q:'', category:'', process:[], material:[], minPrice:'', maxPrice:''},
    editMode: false
  };

  // ====== 工具函数 ======
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const fmt = n => (n==null||isNaN(n))?'—':('$'+ Number(n).toLocaleString('en-US', {maximumFractionDigits:2}));

  function uid(){ return 'id-'+Math.random().toString(36).slice(2)+Date.now().toString(36) }
  function nowISO(){ return new Date().toISOString() }
  function normalizeItem(x){
    return {
      id: x.id || uid(),
      title: String(x.title||'').trim(),
      price: Number(x.price||0),
      currency: (x.currency||'USD').toUpperCase(),
      category: x.category || '',
      material: Array.isArray(x.material) ? x.material : (x.material? [String(x.material)] : []),
      process: Array.isArray(x.process) ? x.process : (x.process? [String(x.process)] : []),
      condition: x.condition || '',
      images: Array.isArray(x.images) ? x.images : [],
      description: String(x.description||''),
      seller: x.seller || null,
      createdAt: x.createdAt || nowISO()
    }
  }

  function deepClone(o){ return JSON.parse(JSON.stringify(o)) }

  // 读取本机或 products.json
  async function loadData(){
    // 1) 尝试 products.json
    try{
      const res = await fetch('products.json', {cache:'no-store'});
      if(res.ok){
        const j = await res.json();
        if(Array.isArray(j)){
          return j.map(normalizeItem);
        }else if(j && Array.isArray(j.items)){
          return j.items.map(normalizeItem);
        }
      }
    }catch(e){ /* 忽略，继续尝试本地 */ }

    // 2) 尝试 localStorage
    try{
      const raw = localStorage.getItem(LS_KEY_MAIN) || localStorage.getItem(LS_KEY_OLD);
      if(raw){
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) return arr.map(normalizeItem);
      }
    }catch(e){}

    // 3) 兜底示例
    const demo = [
      {
        title: "注塑模具 A-12",
        price: 180,
        category: "Injection",
        material: ["Steel"],
        process: ["Injection"],
        condition: "Used",
        images: ["https://images.unsplash.com/photo-1581092921461-eab62e97a780?q=80&w=1200&auto=format&fit=crop"],
        description: "入门级注塑模具，适合小批量生产。包含基本配件。",
        createdAt: "2024-11-01T10:00:00.000Z"
      },
      {
        title: "铝合金压铸模 B-7",
        price: 420,
        category: "Compression",
        material: ["Aluminum"],
        process: ["Compression"],
        condition: "New",
        images: ["https://images.unsplash.com/photo-1581092787767-5e00b4b3c3b2?q=80&w=1200&auto=format&fit=crop"],
        description: "高精度铝合金模具，表面阳极氧化处理。",
        createdAt: "2025-02-10T12:00:00.000Z"
      },
      {
        title: "多腔模 C-9",
        price: 260,
        category: "Injection",
        material: ["Steel", "Alloy"],
        process: ["Injection","Extrusion"],
        condition: "Used",
        images: ["https://images.unsplash.com/photo-1581091014534-8987c1f03f2a?q=80&w=1200&auto=format&fit=crop"],
        description: "多腔位结构，适配标准注塑机，附 CAD 图纸。",
        createdAt: "2025-03-18T09:20:00.000Z"
      }
    ];
    return demo.map(normalizeItem);
  }

  function saveLocal(){
    localStorage.setItem(LS_KEY_MAIN, JSON.stringify(state.all));
    alert('已保存到本机（localStorage）。此数据仅在本浏览器可见。');
  }

  // ====== 渲染筛选选项 ======
  function initFilterOptions(){
    const cats = [...new Set(state.all.map(i=>i.category).filter(Boolean))].sort();
    const pros = [...new Set(state.all.flatMap(i=>i.process||[]).filter(Boolean))].sort();
    const mats = [...new Set(state.all.flatMap(i=>i.material||[]).filter(Boolean))].sort();

    const catSel = $('#category');
    catSel.innerHTML = '<option value="">分类（全部）</option>' + cats.map(c=>`<option value="${encodeHTML(c)}">${encodeHTML(c)}</option>`).join('');

    const proSel = $('#process');
    proSel.innerHTML = pros.map(p=>`<option value="${encodeHTML(p)}">${encodeHTML(p)}</option>`).join('');

    const matSel = $('#material');
    matSel.innerHTML = mats.map(m=>`<option value="${encodeHTML(m)}">${encodeHTML(m)}</option>`).join('');
  }

  function getMultiSelectValues(sel){
    return Array.from(sel.selectedOptions).map(o=>o.value);
  }

  // ====== 过滤、排序、分页 ======
  function applyFilters(){
    const f = state.filters;
    let arr = state.all.slice();

    if(f.q){
      const q = f.q.toLowerCase();
      arr = arr.filter(i => (i.title||'').toLowerCase().includes(q) || (i.description||'').toLowerCase().includes(q));
    }
    if(f.category){
      arr = arr.filter(i => i.category === f.category);
    }
    if(f.process && f.process.length){
      arr = arr.filter(i => (i.process||[]).some(p => f.process.includes(p)));
    }
    if(f.material && f.material.length){
      arr = arr.filter(i => (i.material||[]).some(m => f.material.includes(m)));
    }
    const min = parseFloat(f.minPrice); const max = parseFloat(f.maxPrice);
    if(!isNaN(min)){ arr = arr.filter(i => (i.price||0) >= min) }
    if(!isNaN(max)){ arr = arr.filter(i => (i.price||0) <= max) }

    // 排序
    const sort = state.sort;
    arr.sort((a,b)=>{
      if(sort==='priceAsc') return (a.price||0)-(b.price||0);
      if(sort==='priceDesc') return (b.price||0)-(a.price||0);
      if(sort==='nameAsc') return (a.title||'').localeCompare(b.title||'','zh');
      // latest
      return new Date(b.createdAt||0) - new Date(a.createdAt||0);
    });

    state.filtered = arr;
  }

  function paginate(){
    const total = state.filtered.length;
    const pages = Math.max(1, Math.ceil(total / state.perPage));
    if(state.page > pages) state.page = pages;
    const start = (state.page - 1) * state.perPage;
    const end = start + state.perPage;
    const items = state.filtered.slice(start, end);

    $('#count').textContent = total;
    $('#pageInfo').textContent = `第 ${state.page}/${pages} 页`;
    return items;
  }

  // ====== 渲染列表 ======
  function encodeHTML(s){
    return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }
  function firstImage(arr){ return (arr && arr.length) ? arr[0] : '' }

  function renderList(){
    applyFilters();
    const items = paginate();
    const el = $('#grid');
    el.innerHTML = items.map(cardHTML).join('') || `<div class="muted">没有结果，试试调整筛选条件。</div>`;
  }

  function cardHTML(i){
    const cover = firstImage(i.images);
    const tags = []
    if(i.category) tags.push(i.category);
    if(i.process && i.process.length) tags.push(...i.process);
    if(i.material && i.material.length) tags.push(...i.material);
    return `
      <article class="card">
        <div class="thumb">
          ${cover ? `<img loading="lazy" src="${encodeHTML(cover)}" alt="${encodeHTML(i.title)}" />` : ''}
          <div class="price">${fmt(i.price)}</div>
        </div>
        <div class="body">
          <div class="name">${encodeHTML(i.title||'未命名')}</div>
          <div class="badges">
            ${tags.slice(0,4).map(t=>`<span class="badge">${encodeHTML(t)}</span>`).join('')}
          </div>
          <div class="desc">${encodeHTML(i.description||'')}</div>
        </div>
      </article>
    `;
  }

  // ====== 事件绑定 ======
  function bindUI(){
    // 筛选
    $('#q').addEventListener('input', e => { state.filters.q = e.target.value.trim(); state.page=1; renderList(); });
    $('#category').addEventListener('change', e => { state.filters.category = e.target.value; state.page=1; renderList(); });
    $('#process').addEventListener('change', e => { state.filters.process = getMultiSelectValues(e.target); state.page=1; renderList(); });
    $('#material').addEventListener('change', e => { state.filters.material = getMultiSelectValues(e.target); state.page=1; renderList(); });
    $('#minPrice').addEventListener('input', e => { state.filters.minPrice = e.target.value; state.page=1; renderList(); });
    $('#maxPrice').addEventListener('input', e => { state.filters.maxPrice = e.target.value; state.page=1; renderList(); });
    $('#sort').addEventListener('change', e => { state.sort = e.target.value; state.page=1; renderList(); });
    $('#perPage').addEventListener('change', e => { state.perPage = parseInt(e.target.value)||12; state.page=1; renderList(); });
    $('#btnReset').addEventListener('click', ()=>{
      state.filters = { q:'', category:'', process:[], material:[], minPrice:'', maxPrice:'' };
      $('#q').value = ''; $('#category').value=''; selectClear($('#process')); selectClear($('#material'));
      $('#minPrice').value=''; $('#maxPrice').value='';
      state.page=1; renderList();
    });

    // 翻页
    $('#prev').addEventListener('click', ()=>{ if(state.page>1){ state.page--; renderList(); }});
    $('#next').addEventListener('click', ()=>{
      const pages = Math.max(1, Math.ceil(state.filtered.length / state.perPage));
      if(state.page<pages){ state.page++; renderList(); }
    });

    // 编辑模式开关
    $('#toggleEdit').checked = state.editMode;
    $('#toggleEdit').addEventListener('change', e=>{
      state.editMode = e.target.checked;
      if(state.editMode) location.hash = '#edit'; else history.replaceState(null,'', location.pathname + location.search);
      renderEditPanel();
    });

    // 重新加载（从 products.json）
    $('#btnReload').addEventListener('click', async ()=>{
      state.all = await loadData();
      initFilterOptions();
      state.page=1; renderList();
      if(state.editMode) renderEditPanel();
    });

    // 编辑按钮
    $('#btnNew').addEventListener('click', ()=> openEditor());
    $('#btnImport').addEventListener('click', importJSON);
    $('#btnExport').addEventListener('click', exportJSON);
    $('#btnSaveLocal').addEventListener('click', saveLocal);
  }

  function selectClear(sel){
    Array.from(sel.options).forEach(o=>o.selected=false);
  }

  // ====== 编辑面板 ======
  function renderEditPanel(){
    const p = $('#editPanel');
    p.style.display = state.editMode ? '' : 'none';
    if(!state.editMode) return;

    const list = state.all;
    const el = $('#editList');
    if(!list.length){ el.innerHTML = `<div class="muted">还没有条目，点击“新建条目”。</div>`; return; }
    el.innerHTML = list.map((it, idx)=>{
      const img = firstImage(it.images);
      return `
        <div class="panel" style="display:flex; align-items:center; gap:10px;">
          <div class="thumb" style="width:120px; height:80px; border-radius:10px; overflow:hidden;">
            ${img? `<img src="${encodeHTML(img)}" alt="">` : ''}
          </div>
          <div style="flex:1;">
            <div><strong>${encodeHTML(it.title||'未命名')}</strong></div>
            <div class="muted">${fmt(it.price)} · ${encodeHTML(it.category||'无分类')}</div>
          </div>
          <div style="display:flex; gap:6px;">
            <button class="btn mini" onclick="openEditor('${it.id}')">编辑</button>
            <button class="btn mini" onclick="moveItem('${it.id}',-1)">上移</button>
            <button class="btn mini" onclick="moveItem('${it.id}',1)">下移</button>
            <button class="btn danger mini" onclick="delItem('${it.id}')">删除</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function findIndexById(id){ return state.all.findIndex(x=>x.id===id) }

  function moveItem(id, delta){
    const i = findIndexById(id);
    if(i<0) return;
    const j = i + delta;
    if(j<0 || j>=state.all.length) return;
    const tmp = state.all[i]; state.all[i] = state.all[j]; state.all[j] = tmp;
    renderEditPanel(); renderList();
  }
  function delItem(id){
    if(!confirm('确认删除该条目？')) return;
    const i = findIndexById(id);
    if(i>=0) state.all.splice(i,1);
    renderEditPanel(); renderList();
  }

  // 弹窗编辑器（简易实现）
  function openEditor(id=null){
    const idx = id ? findIndexById(id) : -1;
    const item = idx>=0 ? deepClone(state.all[idx]) : normalizeItem({title:'', price:0, category:'', material:[], process:[], condition:'', images:[], description:''});

    const html = `
      <div id="modal" style="position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:1000;">
        <div class="panel" style="width:min(920px, 92vw); max-height:90vh; overflow:auto;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>${idx>=0 ? '编辑条目' : '新建条目'}</h3>
            <button class="btn mini" onclick="closeModal()">关闭</button>
          </div>

          <div class="editor">
            <div class="grid2">
              <div class="row"><input id="f_title" class="input" placeholder="名称" value="${encodeHTML(item.title)}"></div>
              <div class="row"><input id="f_price" class="input" placeholder="价格（USD）" type="number" min="0" step="1" value="${item.price||0}"></div>
              <div class="row"><input id="f_category" class="input" placeholder="分类（例：Injection）" value="${encodeHTML(item.category)}"></div>
              <div class="row"><input id="f_condition" class="input" placeholder="成色（例：New/Used）" value="${encodeHTML(item.condition)}"></div>
            </div>
            <div class="row"><input id="f_material" class="input" placeholder="材质（逗号分隔）" value="${encodeHTML(item.material.join(', '))}"></div>
            <div class="row"><input id="f_process" class="input" placeholder="工艺（逗号分隔）" value="${encodeHTML(item.process.join(', '))}"></div>
            <div class="row"><textarea id="f_desc" class="input" placeholder="描述" rows="5">${encodeHTML(item.description)}</textarea></div>

            <div class="sep"></div>
            <div class="row" style="justify-content:space-between; align-items:center;">
              <h3>图片</h3>
              <div class="muted">可混合使用远程URL与本地上传图。导出JSON时可选择是否嵌入图片。</div>
            </div>
            <div class="row">
              <input id="f_img_url" class="input" placeholder="粘贴图片 URL 后点击添加">
              <button class="btn mini" onclick="addImageURL()">添加URL</button>
              <input id="f_img_file" type="file" accept="image/*" multiple style="display:none" />
              <button class="btn mini" onclick="document.getElementById('f_img_file').click()">上传文件</button>
            </div>
            <div class="imgs" id="imgs">
              ${item.images.map((src, i)=>imgBox(src, i)).join('')}
            </div>

            <div class="sep"></div>
            <div class="row" style="justify-content:flex-end; gap:8px;">
              ${idx>=0 ? `<button class="btn danger" onclick="delItem('${item.id}'); closeModal()">删除</button>` : ''}
              <button class="btn primary" onclick="saveEditor('${item.id||''}')">保存</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);

    // 绑定文件上传
    const fileInput = document.getElementById('f_img_file');
    fileInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files||[]);
      for(const f of files){
        const dataURL = await fileToDataURL(f);
        item.images.push(dataURL); // 用于预览和可选的嵌入导出
      }
      document.getElementById('imgs').innerHTML = item.images.map((src,i)=>imgBox(src,i)).join('');
      e.target.value = '';
      window.__currentEditingItem = item;
    });

    window.__currentEditingItem = item;
  }

  function closeModal(){
    const m = document.getElementById('modal');
    if(m) m.remove();
    window.__currentEditingItem = null;
  }

  function imgBox(src, i){
    return `
      <div class="ph">
        <img src="${encodeHTML(src)}" alt="">
        <div class="tools">
          <button class="btn mini" onclick="moveImg(${i},-1)">↑</button>
          <button class="btn mini" onclick="moveImg(${i},1)">↓</button>
          <button class="btn danger mini" onclick="delImg(${i})">删</button>
        </div>
      </div>
    `;
  }

  function moveImg(i, d){
    const item = window.__currentEditingItem;
    if(!item) return;
    const j = i+d; if(j<0 || j>=item.images.length) return;
    const t = item.images[i]; item.images[i]=item.images[j]; item.images[j]=t;
    document.getElementById('imgs').innerHTML = item.images.map((src,k)=>imgBox(src,k)).join('');
  }
  function delImg(i){
    const item = window.__currentEditingItem;
    if(!item) return;
    item.images.splice(i,1);
    document.getElementById('imgs').innerHTML = item.images.map((src,k)=>imgBox(src,k)).join('');
  }
  function addImageURL(){
    const input = document.getElementById('f_img_url');
    const url = input.value.trim();
    if(!url) return;
    const item = window.__currentEditingItem;
    item.images.push(url);
    document.getElementById('imgs').innerHTML = item.images.map((src,k)=>imgBox(src,k)).join('');
    input.value='';
  }

  async function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function saveEditor(existingId){
    const item = window.__currentEditingItem;
    if(!item) return;

    const title = document.getElementById('f_title').value.trim();
    const price = parseFloat(document.getElementById('f_price').value||'0');
    const category = document.getElementById('f_category').value.trim();
    const condition = document.getElementById('f_condition').value.trim();
    const material = document.getElementById('f_material').value.split(',').map(s=>s.trim()).filter(Boolean);
    const process = document.getElementById('f_process').value.split(',').map(s=>s.trim()).filter(Boolean);
    const description = document.getElementById('f_desc').value;

    item.title = title; item.price = isNaN(price)?0:price; item.category = category; item.condition = condition;
    item.material = material; item.process = process; item.description = description;
    if(!item.createdAt) item.createdAt = nowISO();

    // 新建或覆盖
    if(existingId){
      const i = findIndexById(existingId);
      if(i>=0) state.all[i] = normalizeItem({...state.all[i], ...item, id:existingId});
    }else{
      state.all.unshift(normalizeItem(item));
    }
    renderEditPanel(); renderList(); closeModal();
  }

  // 导入/导出 JSON
  function importJSON(){
    const input = document.createElement('input');
    input.type='file'; input.accept='application/json';
    input.onchange = async e=>{
      const f = e.target.files[0]; if(!f) return;
      const text = await f.text();
      try{
        const j = JSON.parse(text);
        const arr = Array.isArray(j) ? j : (Array.isArray(j.items) ? j.items : []);
        if(!arr.length) throw new Error('JSON 格式不正确：不是数组或 items 数组为空');
        state.all = arr.map(normalizeItem);
        initFilterOptions(); state.page=1; renderList(); renderEditPanel();
        alert('导入成功');
      }catch(err){
        alert('导入失败：'+err.message);
      }
    };
    input.click();
  }

  function exportJSON(){
    const embed = document.getElementById('embedImages').checked;
    let data = deepClone(state.all);

    if(!embed){
      // 不嵌入图片：仅导出当前 images 字段（可包含URL或相对路径）
      // 不修改
    }else{
      // 保持 dataURL 或 URL 原样；若是本机 file:// 预览生成的 object URL（blob:）建议过滤掉
      data = data.map(it=>{
        it.images = (it.images||[]).filter(u => typeof u==='string' && !u.startsWith('blob:'));
        return it;
      });
    }

    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'products.json';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ====== 启动 ======
  (async function init(){
    state.editMode = location.hash === '#edit';
    state.all = await loadData();
    initFilterOptions();
    bindUI();
    renderList();
    renderEditPanel();
  })();
  </script>
</body>
</html>
